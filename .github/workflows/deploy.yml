name: Deploy Application

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Detectar ambiente actual (compatible con HTML y JSON)
          CURRENT_ENV=$(curl -s http://localhost | grep -i -o 'blue environment\|green environment' | head -1 | tr '[:upper:]' '[:lower:]' | cut -d' ' -f1 || echo "unknown")
          if [ -z "$CURRENT_ENV" ]; then
              CURRENT_ENV=$(curl -s http://localhost | grep -o '"environment":"[^"]*' | cut -d'"' -f4 2>/dev/null || echo "unknown")
          fi
          echo "Ambiente actual detectado: $CURRENT_ENV"
          
          if [ "$CURRENT_ENV" = "blue" ]; then
            echo "ðŸ”„ Desplegando en GREEN..."
            ~/scripts/switch-to-green.sh "${{ secrets.PASSWORD }}"
          else
            echo "ðŸ”„ Desplegando en BLUE..."
            ~/scripts/switch-to-blue.sh "${{ secrets.PASSWORD }}"
          fi
